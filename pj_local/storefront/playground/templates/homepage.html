<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" >
        <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=0" />
        <title>通勤族的救星</title>

    </head>
    <style>
        .bg-default{
            background-color:rgba(213, 177, 16, 0.7);
            color: aqua;
            border-color:blue;
        }
        
        .bg-form{
            background-color:rgba(239, 232, 200, 0.6);
            color:rgba(26, 14, 0, 1);;
        }

        .btn-form{
            background-color:rgba(132, 105, 16, 0.7);
            color:rgba(6, 1, 0, 1);;
        }

        .centerform{
            display: flex;
            justify-content: center; 
            align-items: center;
            padding-top: 0;
            
        }

        .img{
            margin: 0; 
            padding: 0; 
        }
        
        .navbar-center {
            display: inline-block;
            float: none;
            vertical-align: top;
        }
            
        .navbar-collapse-center {
            text-align: center;
        }

        .form{
            padding: 10;
        }

        #leftpic{
            width:660px;
        }


    </style>

<!--橫幅-->
<body>
    <div class="container">
        <div class="row" > 
            <nav class="jumbotron jumbotron-fluid bg-default text-dark">
                <h1 class="display-2" style="text-align:center; font-family:Microsoft JhengHei; font-weight:bold;">通勤族的救星</h1>
            </nav>
         </div>

         <div class="row">
            <p>&emsp;</p>
        </div>
         <div class="row">
            <div class="col-md img">
                {% load static %}
                <img id="leftpic" src="{% static 'w-t-NXYb6Gg4aHY-unsplash.jpeg' %}" alt="commuter">
                
            </div>
            <div class="col-md bg-form centerform">
                <p>&emsp;</p>
                <form action="" method="get">
                    <label for="startpoint">起點:</label>
                    <br>
                    <input type="text" size=35 id="startpoint" name="startpoint" placeholder="Enter a place" required="required">
                    <br><br>
                    <label for="endpoint">終點:</label>
                    <br>
                    <input type="text" size=35 id="endpoint" name="endpoint" placeholder="Enter a place" required="required">
                    <br><br>

                    <label for="date">出發日期:</label>
                    <br>
                    <input type="date" value={{min_date}} min={{min_date}} max={{max_date}} step="1" name="date" id="date">                
                    <br><br>
                    <label for="time">出發時間:</label>
                    <br>
                    <input type='time' name="time" id="time" size=40 min='00:00' max='23:59' step='1'>
                    <br><br>
                    <button type="submit" value="submit" class="btn btn-form">submit</button>
                </form> 
            </div>
        </div>
     
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="crossorigin="anonymous"></script>
<script>

    let autocomplete;
    let autocomplete2;
    location_dic={"start":[],"end":[]}
    function initAutocomplete()
    {   autocomplete2 = new google.maps.places.Autocomplete
        (
            document.getElementById("endpoint"),
            {
                types: ['establishment'],
                componentRestrictions: {'country':['TW']},
                fields: ['name','geometry'],
                bounds:{
                    east:122.00166,
                    west:120.98718,
                    south:24.93971,
                    north:25.29955,
                },
                
            }
        );
        autocomplete = new google.maps.places.Autocomplete
        (
            document.getElementById("startpoint"),
            {
                types: ['establishment'],
                componentRestrictions: {'country':['TW']},
                fields: ['name','geometry'],
                bounds:{
                    east:122.00166,
                    west:120.98718,
                    south:24.93971,
                    north:25.29955,
                }
                
            }
        );
        autocomplete.addListener('place_changed',onPlanceChanged);
        autocomplete2.addListener('place_changed',onPlanceChanged2);    
    }
    function onPlanceChanged()
    {   
        var place = autocomplete.getPlace();
       
        if (!place.geometry) 
        {
            document.getElementById('startpoint').value='';

        }
        else 
        {
            document.getElementById('startpoint').innerHTML=place.name;
            console.log(place);
            location_dic["start"]=[];  
            location_dic["start"].push(place.geometry.location.lat());
            location_dic["start"].push(place.geometry.location.lng());
            console.log(location_dic["start"]);
            if (location_dic["start"].length==2 && location_dic["end"].length==2)
            {
                console.log("it's ready to run init_map");
                initMap()
            }

        }
       
    }
    function onPlanceChanged2()
    {
        var place2 = autocomplete2.getPlace();
       
        if (!place2.geometry) 
        {
            document.getElementById('endpoint').value='';
 
        }
        else 
        {
            document.getElementById('endpoint').innerHTML=place2.name;
            console.log(place2);
            location_dic["end"]=[];  
            location_dic["end"].push(place2.geometry.location.lat());
            location_dic["end"].push(place2.geometry.location.lng());
            console.log(location_dic["end"])
            if (location_dic["start"].length==2 && location_dic["end"].length==2)
            {
                console.log("it's ready to run init_map");
                initMap()
            }
        }
    }
    function initMap() 
    {
        // 載入路線服務與路線顯示圖層
        var directionsService = new google.maps.DirectionsService();
        // 路線相關設定
        var request = 
        {
            origin: { lat:location_dic["start"][0], lng:location_dic["start"][1]},
            destination: { lat:location_dic["end"][0], lng:location_dic["end"][1] },
            travelMode: 'DRIVING',
            avoidFerries: true,
            avoidHighways: true,
            avoidTolls: true,
            provideRouteAlternatives: true,
        };
        path_dic={"path_lat0":[],"path_lat1":[],"path_lat2":[],"path_lng0":[],"path_lng1":[],"path_lng2":[],"path_duration":[]}
        // 繪製路線
        directionsService.route(request, function (result, status) 
        {
            if (status == 'OK') 
            {

                for (i=0;i<result.routes.length;i++)
                    {  path_dic["path_duration"].push(result.routes[i].legs[0].duration.value)
                       for (k=0;k<result.routes[i].legs[0].steps.length;k++)
                        {   
                            for (e=0;e<result.routes[i].legs[0].steps[k].path.length;e++)
                            {   
                                path_dic["path_lat"+i].push(result.routes[i].legs[0].steps[k].path[e].lat()) 
                                path_dic["path_lng"+i].push(result.routes[i].legs[0].steps[k].path[e].lng())       
                            };
                        }; 
                    }
                            var result =false ; //預設值
                
                console.log(path_dic)
                if (path_dic["path_lat0"].length==1)
                {
                    alert('起點與終點距離太近，請重新輸入');
                    document.getElementById('startpoint').value='';
                    document.getElementById('endpoint').value='';

                }
                else
                {
                    $.ajax({
                    url: "/path",
                    type : "post",
                    data : {"data":JSON.stringify(path_dic)},
                    async : false,
                    success : function(data) {
                    result =data['message'] ; //回傳值
                    result2 =data['duration'];
                    console.log(result)
                    console.log(result2)
                    }
                    });  
                }
 
            }
            
            else {
                console.log(status);
            }
        });
    }
</script>
</html>

<script src="https://maps.googleapis.com/maps/api/js?
key=AIzaSyB5WPfBV6n-qOjuJiYmKG8qCG3JbcONopY&libraries=places&callback=initAutocomplete"
async defer></script>